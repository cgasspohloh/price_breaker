(()=>{"use strict";function t(t){let n=[];return t.dataFromMcDavid.detailed.forEach((s=>{let o={ticketTypeId:s.ticket_type_id,ticketTypeName:s.ticket_type_name,sectionName:e(s.section_id,t),unitCost:Math.round(100*s.unit_cost)/100,unitFees:Math.round(100*s.unit_fees)/100,totalCost:Math.round(100*(s.unit_cost+s.unit_fees))/100};n.push(o)})),n}function e(t,e){const n=e.dataFromMcDavid.sections;let s=n.findIndex((e=>e.sectionId==t));return n[s].section}function n(t){const e=document.getElementById("eventName"),n=document.getElementById("eventDate"),s=document.getElementById("location"),o=document.getElementById("ticketLimit"),a=document.getElementById("eventLink"),c=document.getElementById("venue-map");e.textContent="",n.textContent="",s.textContent="",o.textContent="",a.href="",a.textContent="",t&&t.name&&t.date&&t.location&&t.ticketLimit&&t.urlLink?(e.textContent=t.name,n.innerHTML=`<strong>Date:</strong> ${t.date}`,s.innerHTML=`<strong>Location:</strong> ${t.location}`,o.textContent=t.ticketLimit,a.href=t.urlLink,a.textContent="  Ticketmaster Link",t.seatingMap&&(c.innerHTML=`<img src="${t.seatingMap}" alt="Venue Map">`)):e.textContent="Event details not available on Bowman"}function s(t){const e=document.getElementsByClassName("savedEvent");for(let t=0;t<e.length;t++)e[t].classList.remove("clicked");t.classList.add("clicked")}async function o(t,e=""){try{const n=await fetch("/fetchData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:t,api:e})});if(!n.ok)throw new Error("Error fetching data");return await n.json()}catch(t){console.error("Error:",t.message)}}function a(t){const e=[];return t.forEach((t=>{const n=t.sectionName;e.includes(n)||e.push(n)})),e.forEach((n=>{const s=t.filter((t=>t.sectionName===n));if(s.length>0){const t=/^\d+$/.test(n),o=/^\d+\D*$/.test(n),a=/[a-zA-Z]+\s*\d+/.test(n);let c;if(t||o){const t=n.replace(/\D/g,"").toString();let e=t.charAt(0),s=t.length;"0"===e&&(e=t.charAt(1),s-=1,"0"===e&&(e=t.charAt(2),s-=2)),c=s<=1?"1s "+n.replace(/^\d+/,""):e.replace(/^0+/,"")+"0".repeat(s-1)+n.replace(/^\d+/,"")+"s"}else if(a){const t=n.replace(/\D/g,""),e=n.replace(/[0-9]/g,"");let s=t.length,o=t.toString().charAt(0);"0"===o&&(o=t.toString().charAt(1),s-=1,"0"===o&&(o=t.toString().charAt(2),s-=2)),c=s<=1?e+" 1s":e+" "+o+"0".repeat(s-1)+"s"}else{const t=n.substring(0,3),s=e.filter((e=>e.substring(0,3)===t));c=s.length>0?n.substring(0,5):n}s.forEach((t=>{t.level=c}))}})),t}function c(t){const e=document.getElementById("result");e.innerHTML="";const n=document.createElement("table");n.classList.add("data-table");const s=document.createElement("thead"),o=document.createElement("tr");o.innerHTML="<th>Ticket Type</th><th>Levels</th><th>Section</th><th>Unit Cost</th><th>Unit Fees</th><th>Total Cost</th>",s.appendChild(o),n.appendChild(s);const a=document.createElement("tbody"),c={};t.forEach((t=>{const e={level:t.level,sectionName:t.sectionName,unitCost:t.unitCost,unitFees:t.unitFees,totalCost:t.totalCost};c[t.ticketTypeId]||(c[t.ticketTypeId]={sections:[],uniquePairs:new Set}),c[t.ticketTypeId].ticketTypeName=t.ticketTypeName,c[t.ticketTypeId].sections.push(e);const n=`${t.level}_${t.unitCost}`;c[t.ticketTypeId].uniquePairs.has(n)?e.uniquePricing=!1:(c[t.ticketTypeId].uniquePairs.add(n),e.uniquePricing=!0)}));for(const t in c)c[t].sections.sort(((t,e)=>{const n=t.sectionName||"",s=e.sectionName||"",o=n.localeCompare(s);return 0!==o?o:t.unitCost-e.unitCost}));for(const t of Object.keys(c).sort(((t,e)=>{const n=c[t].ticketTypeName||"",s=c[e].ticketTypeName||"";return n.localeCompare(s)}))){const e=document.createElement("tr");e.classList.add("collapsible",i(t)),e.innerHTML=`<td class="first-col">${c[t].ticketTypeName}</td><td></td><td></td><td></td><td></td><td></td>`,c[t].uniquePricing&&e.classList.add("unique-pricing"),a.appendChild(e);const n={},s={};c[t].sections.forEach((({level:e,sectionName:o,unitCost:c,unitFees:d,totalCost:l,uniqueLevel:r,uniquePricing:u})=>{const m=document.createElement("tr");m.classList.add("content",i(t)),u&&m.classList.add("unique-pricing"),m.style.display="none",m.innerHTML=`<td></td><td>${e}</td><td>${o}</td><td>$${c}</td><td>$${d}</td><td>$${l}</td>`,a.appendChild(m),(!n[o]||c<n[o].unitCost)&&(n[o]&&n[o].row.classList.remove("cheapest-section"),m.classList.add("cheapest-section","display"),n[o]={unitCost:c,row:m}),(!s[e]||c<s[e].unitCost)&&(s[e]&&s[e].row.classList.remove("cheapest-level"),m.classList.add("cheapest-level","display"),s[e]={unitCost:c,row:m})})),e.querySelector(".first-col").addEventListener("click",(function(){const e=document.querySelectorAll(`.content.${i(t)}`),n=document.querySelectorAll(`.content.${i(t)}.display`);for(let t=0;t<n.length;t++)n[t].style.display="table-row"===n[t].style.display?"none":"table-row";for(let t=0;t<e.length;t++)e[t].classList.toggle("expanded")}))}n.appendChild(a),e.appendChild(n)}function i(t){return`_${t.replace(/[^\w]/g,"_")}`}function d(t,e){const n=document.querySelectorAll("tr.content");n.forEach((t=>{t.classList.add("display")})),(e||t)&&(!e&&t?n.forEach((t=>{t.classList.contains("cheapest-section")||t.classList.remove("display")})):e&&!t?n.forEach((t=>{t.classList.contains("unique-pricing")||t.classList.remove("display")})):e&&t&&n.forEach((t=>{t.classList.contains("cheapest-level")||t.classList.remove("display")}))),n.forEach((t=>{t.classList.contains("expanded")&&t.classList.contains("display")?t.style.display="table-row":t.style.display="none"}))}let l,r,u;const m=document.getElementById("event-container");let p=!0,v=!0;document.getElementById("eventIdForm").addEventListener("submit",(async e=>{e.preventDefault();const i=document.getElementById("eventIdInput").value;l=await o(i),r=function(t){if(!t||!t.dataFromBowman||!t.dataFromBowman.event)return{name:"Data not available from Bowman",date:"",location:"",urlLink:"",eventId:document.getElementById("eventIdInput").value,city:""};const e=t.dataFromBowman.event,n=t.dataFromDiscovery,s={name:e.event_name,date:e.event_date.substring(0,10),location:`At the ${e.venue_name} in beautiful ${e.city}`,urlLink:"https://www.ticketmaster.com/event/"+e.url_id,eventId:e.url_id,city:e.city,seatingMap:n.seatmap.staticUrl,ticketLimit:n.ticketLimit.info,sales:n.sales};return console.log(s),s}(l),u=t(l),u=a(u),function(t,e){const n=document.createElement("div");n.id=t.eventId,n.classList.add("savedEvent"),s(n),n._savedNewEvent=t,n._savedEventListings=e;const o=document.createElement("button");o.classList.add("deleteEventButton"),o.textContent="X",o.addEventListener("click",(function(){n.remove()})),n.appendChild(o);const a=document.createElement("h3");a.classList.add("eventName","eventInfo"),a.textContent=t.name,n.appendChild(a);const c=document.createElement("p");c.classList.add("eventDate","eventInfo"),c.textContent=t.date,n.appendChild(c);const i=document.createElement("p");i.classList.add("eventLocation","eventInfo"),i.textContent=t.city,n.appendChild(i),document.getElementById("event-container").appendChild(n)}(r,u),n(r),c(u),a(u),d(p,v),document.getElementById("eventIdInput").value=""})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("refetchAllButton"),n=document.getElementById("timeDropdown");function s(){const e=document.getElementsByClassName("savedEvent");for(let n=0;n<e.length;n++){const s=e[n],i=s._savedNewEvent.eventId;o(i,"mcdavid").then((e=>{u=t(e),u=a(u),s._savedEventListings=u,s.classList.contains("clicked")&&(c(u),d(p,v))})).catch((t=>{console.error(`Error fetching data for event ID ${i}:`,t.message)}))}}e.addEventListener("click",(function(){const t=n.value;if("now"!==t){const e=new Date,n=parseInt(t.split(":")[0],10),o=parseInt(t.split(":")[1],10),a=new Date(e);a.setHours(n,o,0,0);const c=a-e;c>0?(function(t){let e=t;const n=document.getElementById("timerCount"),s=setInterval((function(){const t=Math.floor(e/1e3);n.textContent=`${function(t){const e=Math.floor(t/60),n=t%60;return`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}(t)}`,e-=1e3,e<0&&(clearInterval(s),n="")}),1e3)}(c),setTimeout((function(){console.log("Timer up: Re-fetching Data"),s()}),c+1e4)):console.error("Selected time has already passed for today.")}else s()}))})),m.addEventListener("click",(t=>{const e=t.target.closest(".savedEvent");if(s(e),e){const t=e._savedNewEvent,s=e._savedEventListings;n(t),c(s)}})),document.getElementById("cheapest-section-toggle").addEventListener("change",(function(){p=!p,d(p,v)})),document.getElementById("unqiue-pricing-toggle").addEventListener("change",(function(){v=!v,d(p,v)}))})();