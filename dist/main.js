(()=>{"use strict";function t(t){let n=[];return t.dataFromMcDavid.detailed.forEach((o=>{let s={ticketTypeId:o.ticket_type_id,ticketTypeName:o.ticket_type_name,sectionName:e(o.section_id,t),unitCost:Math.round(100*o.unit_cost)/100,unitFees:Math.round(100*o.unit_fees)/100,totalCost:Math.round(100*(o.unit_cost+o.unit_fees))/100};n.push(s)})),n}function e(t,e){const n=e.dataFromMcDavid.sections;let o=n.findIndex((e=>e.sectionId==t));return n[o].section}function n(t){const e=document.getElementById("eventName"),n=document.getElementById("eventDate"),o=document.getElementById("location"),s=document.getElementById("eventLink");e.textContent="",n.textContent="",o.textContent="",s.href="",s.textContent="",t&&t.name&&t.date&&t.location&&t.urlLink?(e.textContent=t.name,n.textContent="Date: "+t.date,o.textContent="Location: "+t.location,s.href=t.urlLink,s.textContent="  Ticketmaster Link"):e.textContent="Event details not available on Bowman"}function o(t){const e=document.getElementsByClassName("savedEvent");for(let t=0;t<e.length;t++)e[t].classList.remove("clicked");t.classList.add("clicked")}async function s(t,e=""){try{const n=await fetch("/fetchData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:t,api:e})});if(!n.ok)throw new Error("Error fetching data");return await n.json()}catch(t){console.error("Error:",t.message)}}function c(t){const e=[];return t.forEach((t=>{const n=t.sectionName;e.includes(n)||e.push(n)})),e.forEach((n=>{const o=t.filter((t=>t.sectionName===n));if(o.length>0){const t=/^\d+$/.test(n),s=/^\d+\D*$/.test(n),c=/[a-zA-Z]+\s*\d+/.test(n);let a;if(t||s){const t=n.replace(/\D/g,"").toString();let e=t.charAt(0),o=t.length;"0"===e&&(e=t.charAt(1),o-=1,"0"===e&&(e=t.charAt(2),o-=2)),a=o<=1?"1s "+n.replace(/^\d+/,""):e.replace(/^0+/,"")+"0".repeat(o-1)+n.replace(/^\d+/,"")+"s"}else if(c){const t=n.replace(/\D/g,""),e=n.replace(/[0-9]/g,"");let o=t.length,s=t.toString().charAt(0);"0"===s&&(s=t.toString().charAt(1),o-=1,"0"===s&&(s=t.toString().charAt(2),o-=2)),a=o<=1?e+" 1s":e+" "+s+"0".repeat(o-1)+"s"}else{const t=n.substring(0,3),o=e.filter((e=>e.substring(0,3)===t));a=o.length>0?n.substring(0,5):n}o.forEach((t=>{t.level=a}))}})),t}function a(t){const e=document.getElementById("result");e.innerHTML="";const n=document.createElement("table");n.classList.add("data-table");const o=document.createElement("thead"),s=document.createElement("tr");s.innerHTML="<th>Ticket Type</th><th>Levels</th><th>Section</th><th>Unit Cost</th><th>Unit Fees</th><th>Total Cost</th>",o.appendChild(s),n.appendChild(o);const c=document.createElement("tbody"),a={};t.forEach((t=>{const e={level:t.level,sectionName:t.sectionName,unitCost:t.unitCost,unitFees:t.unitFees,totalCost:t.totalCost};a[t.ticketTypeId]||(a[t.ticketTypeId]={sections:[]}),a[t.ticketTypeId].ticketTypeName=t.ticketTypeName,a[t.ticketTypeId].sections.push(e)}));for(const t in a)a[t].sections.sort(((t,e)=>{const n=t.sectionName||"",o=e.sectionName||"",s=n.localeCompare(o);return 0!==s?s:t.unitCost-e.unitCost}));for(const t of Object.keys(a).sort(((t,e)=>{const n=a[t].ticketTypeName||"",o=a[e].ticketTypeName||"";return n.localeCompare(o)}))){const e=document.createElement("tr");e.classList.add("collapsible",i(t)),e.innerHTML=`<td class="first-col">${a[t].ticketTypeName}</td><td></td><td></td><td></td><td></td><td></td>`,c.appendChild(e);const n={},o={};a[t].sections.forEach((({level:e,sectionName:s,unitCost:a,unitFees:d,totalCost:l})=>{const r=document.createElement("tr");r.classList.add("content",i(t)),r.style.display="none",r.innerHTML=`<td></td><td>${e}</td><td>${s}</td><td>$${a}</td><td>$${d}</td><td>$${l}</td>`,c.appendChild(r),(!n[s]||a<n[s].unitCost)&&(n[s]&&n[s].row.classList.remove("cheapest-section"),r.classList.add("cheapest-section","display"),n[s]={unitCost:a,row:r}),(!o[e]||a<o[e].unitCost)&&(o[e]&&o[e].row.classList.remove("cheapest-level"),r.classList.add("cheapest-level","display"),o[e]={unitCost:a,row:r})})),e.querySelector(".first-col").addEventListener("click",(function(){const e=document.querySelectorAll(`.content.${i(t)}`),n=document.querySelectorAll(`.content.${i(t)}.display`);for(let t=0;t<n.length;t++)n[t].style.display="table-row"===n[t].style.display?"none":"table-row";for(let t=0;t<e.length;t++)e[t].classList.toggle("expanded")}))}function i(t){return`_${t.replace(/[^\w]/g,"_")}`}n.appendChild(c),e.appendChild(n)}let i,d,l;const r=document.getElementById("event-container");let u=!0;document.getElementById("eventIdForm").addEventListener("submit",(async e=>{e.preventDefault();const r=document.getElementById("eventIdInput").value;i=await s(r),d=function(t){if(!t||!t.dataFromBowman||!t.dataFromBowman.event)return{name:"Data not available from Bowman",date:"",location:"",urlLink:"",eventId:document.getElementById("eventIdInput").value,city:""};const e=t.dataFromBowman.event;return{name:e.event_name,date:e.event_date.substring(0,10),location:`At the ${e.venue_name} in beautiful ${e.city}`,urlLink:"https://www.ticketmaster.com/event/"+e.url_id,eventId:e.url_id,city:e.city}}(i),l=t(i),l=c(l),function(t,e){const n=document.createElement("div");n.id=t.eventId,n.classList.add("savedEvent"),o(n),n._savedNewEvent=t,n._savedEventListings=e;const s=document.createElement("button");s.classList.add("deleteEventButton"),s.textContent="X",s.addEventListener("click",(function(){n.remove()})),n.appendChild(s);const c=document.createElement("h3");c.classList.add("eventName","eventInfo"),c.textContent=t.name,n.appendChild(c);const a=document.createElement("p");a.classList.add("eventDate","eventInfo"),a.textContent=t.date,n.appendChild(a);const i=document.createElement("p");i.classList.add("eventLocation","eventInfo"),i.textContent=t.city,n.appendChild(i),document.getElementById("event-container").appendChild(n)}(d,l),n(d),a(l),c(l),document.getElementById("eventIdInput").value=""})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("refetchAllButton"),n=document.getElementById("timeDropdown");function o(){const e=document.getElementsByClassName("savedEvent");for(let n=0;n<e.length;n++){const o=e[n],i=o._savedNewEvent.eventId;s(i,"mcdavid").then((e=>{l=t(e),l=c(l),o._savedEventListings=l,o.classList.contains("clicked")&&a(l)})).catch((t=>{console.error(`Error fetching data for event ID ${i}:`,t.message)}))}}e.addEventListener("click",(function(){const t=n.value;if("now"!==t){const e=new Date,n=parseInt(t.split(":")[0],10),s=parseInt(t.split(":")[1],10),c=new Date(e);c.setHours(n,s,0,0);const a=c-e;a>0?(function(t){let e=t;const n=document.getElementById("timerCount"),o=setInterval((function(){const t=Math.floor(e/1e3);n.textContent=`${function(t){const e=Math.floor(t/60),n=t%60;return`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}(t)}`,e-=1e3,e<0&&clearInterval(o)}),1e3)}(a),setTimeout((function(){console.log("Timer up: Re-fetching Data"),o()}),a)):console.error("Selected time has already passed for today.")}else o()}))})),r.addEventListener("click",(t=>{const e=t.target.closest(".savedEvent");if(o(e),e){const t=e._savedNewEvent,o=e._savedEventListings;n(t),a(o)}})),document.getElementById("cheapest-section-toggle").addEventListener("change",(function(){u=!u,function(t){document.querySelectorAll(".cheapest");const e=document.querySelectorAll("tr.content");t?e.forEach((t=>{t.classList.contains("cheapest-section")||t.classList.remove("display")})):e.forEach((t=>{t.classList.add("display")})),e.forEach((t=>{t.classList.contains("expanded")&&t.classList.contains("display")?t.style.display="table-row":t.style.display="none"}))}(u)}))})();